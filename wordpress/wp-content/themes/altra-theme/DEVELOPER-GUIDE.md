# Visual Page Builder - Developer Guide

## Architecture Overview

This Visual Page Builder system consists of two main React applications integrated into WordPress:

1. **Grid Manager** - Frontend grid editing interface
2. **Card Editor** - Admin meta box for visual card customization

---

## Tech Stack

### Frontend
- **React 18.3.1** (via `@wordpress/element`)
- **@wordpress/scripts** - Build tooling (webpack, babel, etc.)
- **GridStack.js 12.3.3** - Grid drag & drop
- **react-easy-crop 5.5.6** - Focal point picker
- **react-beautiful-dnd 13.1.1** - Text layers reordering

### Backend
- **WordPress REST API** - Custom endpoints under `altra/v1`
- **Post Meta Fields** - JSON storage for positions and settings
- **Conditional Asset Loading** - Only load when needed

---

## Project Structure

```
assets/js/src/
├── grid-manager/
│   ├── index.js                    # Entry point
│   ├── GridManagerApp.js           # Root component
│   ├── style.scss                  # Styles
│   ├── components/
│   │   ├── GridContainer.js        # GridStack wrapper
│   │   ├── ProjectTile.js          # Individual project tile
│   │   ├── ProjectSidebar.js       # Available projects sidebar
│   │   └── WidthSelector.js        # S/M/L buttons (integrated in ProjectTile)
│   └── utils/
│       └── api.js                  # REST API calls
│
└── card-editor/
    ├── index.js                    # Entry point
    ├── CardEditorApp.js            # Root component
    ├── style.scss                  # Styles
    ├── components/
    │   ├── FocalPointPicker.js     # Focal point picker (react-easy-crop)
    │   ├── ImageZoomControl.js     # Zoom slider + presets
    │   ├── TextLayerEditor.js      # Text layers management
    │   └── PreviewCard.js          # Live preview
    └── utils/
        └── (empty for now)

build/                              # Auto-generated by webpack
├── grid-manager.js                 # 87.5 KB (minified)
├── grid-manager.css                # GridStack styles
├── style-grid-manager.css          # Custom styles
├── card-editor.js                  # 133 KB (minified)
└── style-card-editor.css           # Custom styles
```

---

## Build System

### Commands

```bash
# Development mode (watch + hot reload)
npm run start

# Production build (minified)
npm run build
```

### Webpack Configuration

File: `webpack.config.js`

```javascript
const defaultConfig = require('@wordpress/scripts/config/webpack.config');
const path = require('path');

module.exports = {
	...defaultConfig,
	entry: {
		'grid-manager': path.resolve(__dirname, 'assets/js/src/grid-manager/index.js'),
		'card-editor': path.resolve(__dirname, 'assets/js/src/card-editor/index.js'),
	},
	output: {
		path: path.resolve(__dirname, 'build'),
		filename: '[name].js',
	},
};
```

---

## Grid Manager

### How It Works

1. **Button on Homepage** (`front-page.php`)
   - Rendered only for logged-in users with `edit_posts` capability
   - Triggers React app via `#altra-grid-manager-root`

2. **React App Initialization** (`grid-manager/index.js`)
   - Checks for root element and `window.altraGridData`
   - Renders `<GridManagerApp />`

3. **State Management** (`GridManagerApp.js`)
   - `allProjects` - All available projects from REST API
   - `gridItems` - Projects currently in the grid
   - `isEditMode` - Toggle overlay on/off

4. **GridStack Integration** (`GridContainer.js`)
   - 12-column grid, `cellHeight: 100px`, `margin: 10px`
   - Listens to `change` event → updates state
   - Syncs React state with GridStack engine

5. **Save Flow**
   - Collect all grid positions from state
   - POST to `/wp-json/altra/v1/grid-positions`
   - Backend saves to `_altra_grid_position` meta field
   - Also saves `_altra_grid_order` for fallback sorting

### REST API Endpoints

**GET `/wp-json/altra/v1/projects`**

Returns all projects with grid data:

```json
[
  {
    "id": 123,
    "title": "Project Title",
    "thumbnail": "https://...",
    "width": "medium",
    "gridPosition": {
      "x": 0,
      "y": 0,
      "w": 6,
      "h": 2
    }
  }
]
```

**POST `/wp-json/altra/v1/grid-positions`**

Saves positions for all projects:

```json
{
  "positions": [
    {
      "id": 123,
      "x": 0,
      "y": 0,
      "w": 6,
      "h": 2,
      "order": 0
    }
  ]
}
```

### Frontend Rendering

File: `front-page.php`

```php
// Query projects ordered by grid order
$args = array(
    'post_type' => 'project',
    'meta_key' => '_altra_grid_order',
    'orderby' => 'meta_value_num date',
    'order' => 'ASC',
);

// Apply grid positions via inline styles
$grid_position = get_post_meta(get_the_ID(), '_altra_grid_position', true);

if (!empty($grid_position)) {
    $grid_styles = sprintf(
        'grid-column: %d / %d; grid-row: %d / %d;',
        $x + 1, // CSS Grid is 1-based
        $x + $w + 1,
        $y + 1,
        $y + $h + 1
    );
}
```

---

## Card Editor

### How It Works

1. **Meta Box Registration** (`functions.php`)
   - `altra_add_project_meta_boxes()` adds meta box
   - `altra_visual_card_editor_callback()` renders root + passes data

2. **Data Passing**
   - Via `window.altraCardEditorData` inline script
   - Includes: postId, featuredImage, currentSettings, projectTitle, nonce

3. **React App** (`CardEditorApp.js`)
   - Reads from `window.altraCardEditorData`
   - Manages state: `focalPoint`, `zoom`, `textLayers`
   - Updates hidden input `#altra_visual_settings_input` on every change

4. **Save Flow**
   - WordPress `save_post_project` hook
   - Reads from `$_POST['altra_visual_settings']`
   - Validates JSON structure
   - Sanitizes values
   - Saves to `_altra_visual_settings` meta field

### Components Deep Dive

#### FocalPointPicker

Uses `react-easy-crop` to let user pan/zoom image:

```javascript
<Cropper
  image={image}
  crop={crop}
  zoom={zoom}
  aspect={4/3}
  onCropComplete={onCropComplete}
  objectFit="contain"
/>
```

Calculates focal point as % of image dimensions.

#### ImageZoomControl

Simple slider + preset buttons:

```javascript
<input
  type="range"
  min="1"
  max="2.5"
  step="0.1"
  value={zoom}
  onChange={(e) => onZoomChange(parseFloat(e.target.value))}
/>
```

#### TextLayerEditor

Uses `react-beautiful-dnd` for reordering:

```javascript
<DragDropContext onDragEnd={handleDragEnd}>
  <Droppable droppableId="text-layers">
    {/* Draggable items */}
  </Droppable>
</DragDropContext>
```

#### PreviewCard

Applies transform CSS in real-time:

```javascript
const imageStyle = {
  transformOrigin: `${focalPoint.x}% ${focalPoint.y}%`,
  transform: `scale(${zoom})`,
  objectFit: 'contain',
};
```

### Frontend Rendering

File: `front-page.php`

```php
$visual_settings = get_post_meta(get_the_ID(), '_altra_visual_settings', true);

if (!empty($visual_settings)) {
    $focal_x = $visual_settings['focalPoint']['x'];
    $focal_y = $visual_settings['focalPoint']['y'];
    $zoom = $visual_settings['zoom'];

    $image_style = sprintf(
        'transform-origin: %s%% %s%%; transform: scale(%s);',
        $focal_x,
        $focal_y,
        $zoom
    );
}

the_post_thumbnail('project-thumbnail', array('style' => $image_style));
```

---

## Data Schemas

### Grid Position (`_altra_grid_position`)

```json
{
  "x": 0,        // Column index (0-11)
  "y": 0,        // Row index (0-∞)
  "w": 6,        // Width in columns (4, 6, or 12)
  "h": 2,        // Height (always 2)
  "order": 1     // Fallback order
}
```

Also saved: `_altra_grid_order` (integer) for sorting.

### Visual Settings (`_altra_visual_settings`)

```json
{
  "focalPoint": {
    "x": 50,     // % from left (0-100)
    "y": 50      // % from top (0-100)
  },
  "zoom": 1.0,   // Scale factor (1.0 - 2.5)
  "textLayers": [
    {
      "id": "title",
      "visible": true,
      "size": "medium",  // small, medium, large
      "position": {
        "x": 20,   // % from left
        "y": 80    // % from top
      }
    }
  ]
}
```

---

## Security & Permissions

### Grid Manager

- **Frontend Access**: `is_user_logged_in() && current_user_can('edit_posts')`
- **REST API**: `altra_check_edit_permission()` checks `edit_posts` capability
- **Nonce**: `X-WP-Nonce` header required

### Card Editor

- **Admin Access**: Only in admin on post edit screen
- **Save**: Standard WordPress `save_post` hook with nonce verification
- **Sanitization**: All values sanitized before saving (floatval, sanitize_text_field)

---

## CSS Integration

### Grid Layout

File: `assets/css/flexible-layout.css`

```css
.projects-grid {
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    gap: 30px;
    grid-auto-rows: minmax(100px, auto);
}
```

### Image Transforms

```css
.project-card img {
    object-fit: contain;
    transition: transform 0.6s ease, transform-origin 0.3s ease;
}

/* Hover: only if no custom transform */
.project-card:hover img:not([style*="transform:"]) {
    transform: scale(1.02);
}

/* Hover: enhance custom transforms */
.project-card:hover img[style*="transform:"] {
    filter: brightness(1.05);
}
```

---

## Debugging

### Enable Debug Mode

```javascript
// In grid-manager/GridManagerApp.js or card-editor/CardEditorApp.js
console.log('Current state:', { focalPoint, zoom, textLayers });
```

### Check REST API

```bash
# Get all projects
curl -X GET https://yoursite.com/wp-json/altra/v1/projects \
  -H "X-WP-Nonce: YOUR_NONCE"

# Save grid positions
curl -X POST https://yoursite.com/wp-json/altra/v1/grid-positions \
  -H "Content-Type: application/json" \
  -H "X-WP-Nonce: YOUR_NONCE" \
  -d '{"positions":[{"id":123,"x":0,"y":0,"w":6,"h":2,"order":0}]}'
```

### Check Meta Fields

```php
// In WordPress admin or functions.php
$grid_pos = get_post_meta(123, '_altra_grid_position', true);
var_dump($grid_pos);

$visual = get_post_meta(123, '_altra_visual_settings', true);
var_dump($visual);
```

---

## Extending the System

### Add New Grid Width

1. Update `ProjectTile.js` widthOptions array
2. Update `flexible-layout.css` with new class
3. Update REST API to handle new width value

### Add New Text Layer Field

1. Add to `altra_get_project_fields()` in `functions.php`
2. Update `TextLayerEditor.js` availableFields array
3. Update frontend rendering in `front-page.php`

### Change Grid Column Count

1. Update `GridContainer.js`: `column: 12` → `column: 16`
2. Update `flexible-layout.css`: `grid-template-columns: repeat(12, 1fr)` → `repeat(16, 1fr)`
3. Update width calculations in save handler

---

## Performance Considerations

### Asset Loading

- Grid Manager: Only on homepage for logged-in editors
- Card Editor: Only in admin on project edit screen
- Conditional checks prevent unnecessary loading

### Build Sizes

- Grid Manager: ~87 KB (GridStack included)
- Card Editor: ~133 KB (react-easy-crop, react-beautiful-dnd included)
- Both minified in production

### Database Queries

- Grid positions: Single query per project (cached)
- Visual settings: Single query per project (cached)
- REST API: Batch fetch all projects at once

---

## Testing Checklist

### Grid Manager
- [ ] Button appears only when logged in with edit_posts
- [ ] Overlay opens/closes correctly
- [ ] Drag & drop works smoothly
- [ ] Width changes (S/M/L) update grid
- [ ] Add/remove projects works
- [ ] Save persists positions
- [ ] Cancel discards changes
- [ ] Frontend displays saved grid

### Card Editor
- [ ] Meta box appears on project edit screen
- [ ] Focal point picker works
- [ ] Zoom slider updates preview
- [ ] Text layers can be toggled
- [ ] Text layers can be reordered
- [ ] Size buttons (S/M/L) work
- [ ] Reset button clears all
- [ ] Save persists settings
- [ ] Frontend displays transforms

### Cross-browser
- [ ] Chrome
- [ ] Firefox
- [ ] Safari
- [ ] Edge

### Mobile
- [ ] Grid responsive on small screens
- [ ] Admin interfaces usable on tablet

---

## Troubleshooting

### Build Fails

```bash
# Clear node_modules and reinstall
rm -rf node_modules package-lock.json
npm install --legacy-peer-deps
npm run build
```

### React Not Rendering

- Check browser console for errors
- Verify root element exists in DOM
- Verify `window.altraGridData` / `window.altraCardEditorData` is set
- Check asset enqueue conditions

### GridStack Not Working

- Verify `gridstack/dist/gridstack.min.css` is loaded
- Check for JavaScript errors
- Verify GridStack version compatibility

### Transforms Not Applying

- Check meta field data structure
- Verify inline styles in HTML source
- Check CSS specificity conflicts

---

## Future Improvements

### Potential Features

1. **Text Layer Positioning**
   - Visual drag to position text on preview
   - Currently only visibility/size/order

2. **Multiple Focal Points**
   - Different focal points per viewport size
   - Responsive focal point adjustments

3. **Grid Templates**
   - Save/load predefined grid layouts
   - Quick layout switching

4. **Undo/Redo**
   - History stack for grid changes
   - Revert to previous states

5. **Keyboard Shortcuts**
   - Arrow keys to move tiles
   - Ctrl+S to save

6. **Real-time Collaboration**
   - WebSocket updates when multiple editors

---

## Support & Maintenance

### Regular Tasks

- Update npm dependencies quarterly
- Test with new WordPress versions
- Monitor browser compatibility
- Review error logs

### Breaking Changes to Avoid

- Don't change meta field keys (`_altra_grid_position`, `_altra_visual_settings`)
- Don't change REST API endpoint URLs
- Don't change JSON data structure (add fields, don't remove)
- Maintain backward compatibility

---

**Last Updated**: December 2024
**Author**: Claude Sonnet 4.5 (via Claude Code)
**WordPress Version**: 6.7+
**Node Version**: 18+
